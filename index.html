<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lettore Codice Fiscale â†’ EtÃ </title>

  <!-- Quagga -->
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

  <!-- Manifest per PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Lettore CF">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    body { font-family:-apple-system,system-ui,Roboto,Arial; margin:16px; line-height:1.4; }
    h1 { font-size:22px; margin:0 0 12px; }
    button, input {
      font-size:16px; padding:10px; border-radius:8px; border:1px solid #ccc; margin:4px;
    }
    .out { padding:10px; border:1px solid #ddd; border-radius:8px; background:#fafafa; margin-bottom:12px; }
    .ok { color:#008855; font-weight:600; }
    .err { color:#c00; font-weight:600; }
    small { color:#666; }
    #videoContainer {
      position:relative; width:100%; max-width:480px; margin:auto;
      border-radius:8px; overflow:hidden; background:#000;
    }
    video { width:100%; display:block; border-radius:8px; }
    canvas.drawingBuffer {
      position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;
    }
  </style>
</head>
<body>
  <h1>Lettore Codice Fiscale â†’ EtÃ </h1>
  <div id="out" class="out">Inquadra il codice a barre della tessera sanitaria o inserisci il CF manualmente.</div>

  <div>
    <button id="btnStart">ðŸ“¸ Avvia fotocamera</button>
    <button id="btnStop">â›” Stop</button>
    <button id="btnTorch">ðŸ’¡ Torcia</button>
  </div>

  <div id="videoContainer">
    <video id="preview" autoplay muted playsinline></video>
    <canvas class="drawingBuffer"></canvas>
  </div>

  <p><small>Tutto in locale: nessun dato inviato. Su iPhone apri questa app dalla schermata Home per usare la fotocamera.</small></p>

  <div>
    <label>Oppure inserisci il Codice Fiscale:</label><br>
    <input id="manual" maxlength="16" style="width:100%;max-width:480px" placeholder="RSSMRA85T10A562S">
    <button id="btnParse">Calcola etÃ </button>
  </div>

  <script>
    const out = document.getElementById('out');
    const manual = document.getElementById('manual');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnParse = document.getElementById('btnParse');
    const btnTorch = document.getElementById('btnTorch');

    let track = null;

    function show(msg, cls=""){ out.innerHTML=`<div class="${cls}">${msg}</div>`; }

    function parseCF(cfRaw){
      const cf = (cfRaw||"").trim().toUpperCase();
      if(!/^[A-Z0-9]{16}$/.test(cf)) throw new Error("CF non valido (16 caratteri).");
      const YY=cf.slice(6,8), M=cf[8], DD0=parseInt(cf.slice(9,11),10);
      const months={A:1,B:2,C:3,D:4,E:5,H:6,L:7,M:8,P:9,R:10,S:11,T:12};
      const month=months[M]; if(!month) throw new Error("Mese CF non valido.");
      let DD=DD0,female=false; if(DD>=41){female=true;DD-=40;}
      const now=new Date(), yy=parseInt(YY), year=(yy<=now.getFullYear()%100)?2000+yy:1900+yy;
      const birth=new Date(year,month-1,DD);
      let age=now.getFullYear()-birth.getFullYear();
      const mDiff=now.getMonth()-birth.getMonth();
      if(mDiff<0||(mDiff===0&&now.getDate()<birth.getDate())) age--;
      return {cf,birthISO:birth.toISOString().slice(0,10),age,gender:female?"F":"M"};
    }

    btnStart.onclick = async () => {
      show("ðŸ“¸ Avvio fotocamera...");
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "environment",
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });
        const video = document.getElementById('preview');
        video.srcObject = stream;
        track = stream.getVideoTracks()[0];
      } catch (e) {
        show("Errore accesso fotocamera: consenti lâ€™uso o apri dalla Home.", "err");
        return;
      }

      Quagga.init({
        inputStream:{
          type:"LiveStream",
          target:document.querySelector('#videoContainer'),
          constraints:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},
          area:{top:"40%",right:"10%",left:"10%",bottom:"40%"}
        },
        decoder:{
          readers:["code_39_reader"],
          debug:false
        },
        locate:true,
        numOfWorkers:0,
        frequency:2
      },(err)=>{
        if(err){console.error(err);show("Errore inizializzazione.","err");return;}
        Quagga.start();
        show("Inquadra il codice a barre al centro...");
      });

      Quagga.onProcessed((result)=>{
        const ctx=Quagga.canvas.ctx.overlay;
        const canvas=Quagga.canvas.dom.overlay;
        if(!ctx||!canvas)return;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(result && result.box){
          Quagga.ImageDebug.drawPath(result.box,{x:0,y:1},ctx,{color:"#00F",lineWidth:3});
        }
      });

      Quagga.onDetected((data)=>{
        const text=data.codeResult.code;
        if(text){
          handleCandidate(text);
        }
      });
    };

    btnStop.onclick = ()=>{
      try { Quagga.stop(); } catch {}
      if(track){track.stop(); track=null;}
      show("Scanner fermo.");
    };

    btnTorch.onclick = async ()=>{
      if(!track){alert("Avvia prima la fotocamera.");return;}
      try{
        const capabilities = track.getCapabilities();
        if(capabilities.torch){
          const newTorch = !track._torchOn;
          await track.applyConstraints({advanced:[{torch:newTorch}]});
          track._torchOn = newTorch;
          btnTorch.textContent = newTorch ? "ðŸ’¡ Torcia ON" : "ðŸ’¡ Torcia";
        } else {
          alert("Torcia non supportata su questo dispositivo.");
        }
      }catch(e){
        alert("Impossibile controllare la torcia su iPhone (limite Safari).");
      }
    };

    function handleCandidate(text){
      const m=text.toUpperCase().match(/[A-Z0-9]{16}/);
      const cfCandidate=m?m[0]:text;
      try{
        const info=parseCF(cfCandidate);
        show(`âœ… CF: <b>${info.cf}</b><br>Data di nascita: <b>${info.birthISO}</b><br>Sesso: <b>${info.gender}</b><br>EtÃ  oggi: <b>${info.age}</b> anni`,"ok");
        Quagga.stop();
        if(track){track.stop();}
      }catch(e){
        show("Letto: "+text+"<br>"+e.message,"err");
      }
    }

    btnParse.onclick = ()=>{
      try{
        const info=parseCF(manual.value);
        show(`âœ… CF: <b>${info.cf}</b><br>Data di nascita: <b>${info.birthISO}</b><br>Sesso: <b>${info.gender}</b><br>EtÃ  oggi: <b>${info.age}</b> anni`,"ok");
      }catch(e){show(e.message,"err");}
    };
  </script>
</body>
</html>

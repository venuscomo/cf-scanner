<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lettore Codice Fiscale → Età (on-device)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px;line-height:1.4}
    h1{font-size:20px;margin:0 0 12px}
    video{width:100%;max-width:480px;border:1px solid #ccc;border-radius:8px}
    .row{margin:12px 0}
    .out{padding:10px;border:1px solid #eee;border-radius:8px;background:#fafafa}
    button,input{font-size:16px;padding:10px;border-radius:8px;border:1px solid #ccc}
    .ok{color:#0a7}
    .err{color:#c00}
    small{color:#666}
  </style>
</head>
<body>
  <h1>Lettore Codice Fiscale → Età</h1>
  <p><small>Tutto in locale: nessun dato inviato. Usa HTTPS per la fotocamera su iOS.</small></p>

  <div class="row">
    <button id="btnStart">Avvia fotocamera</button>
    <button id="btnStop">Stop</button>
  </div>

  <div class="row">
    <video id="preview" muted playsinline></video>
  </div>

  <div class="row">
    <label for="manual">Oppure inserisci il Codice Fiscale:</label><br>
    <input id="manual" placeholder="RSSMRA85T10A562S" maxlength="16" style="width:100%;max-width:480px">
    <button id="btnParse">Calcola età</button>
  </div>

  <div id="out" class="out">Inquadra il barcode della tessera sanitaria o inserisci il CF manualmente.</div>

  <!-- Script principale: ZXing da CDN (serve connessione al primo caricamento) -->
  <script type="module">
    import { BrowserMultiFormatReader, NotFoundException } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm5/index.min.js";

    const video    = document.getElementById('preview');
    const out      = document.getElementById('out');
    const btnStart = document.getElementById('btnStart');
    const btnStop  = document.getElementById('btnStop');
    const manual   = document.getElementById('manual');
    const btnParse = document.getElementById('btnParse');

    let codeReader = null;
    let currentStream = null;
    let scanning = false;

    // --- Parsing CF → data di nascita + età ---
    function parseCF(cfRaw){
      const cf = (cfRaw || "").trim().toUpperCase();
      if(!/^[A-Z0-9]{16}$/.test(cf)) throw new Error("CF non valido (16 caratteri alfanumerici).");

      const YY = cf.slice(6, 8);
      const M  = cf[8];
      let DD   = parseInt(cf.slice(9, 11), 10);

      const months = {A:1,B:2,C:3,D:4,E:5,H:6,L:7,M:8,P:9,R:10,S:11,T:12};
      const month = months[M];
      if(!month) throw new Error("Mese CF non valido.");

      let female = false;
      if(DD >= 41){ female = true; DD = DD - 40; }

      const now = new Date();
      const currYY = now.getFullYear() % 100;
      const yyNum = parseInt(YY, 10);
      const year = (yyNum <= currYY) ? (2000 + yyNum) : (1900 + yyNum);

      const birth = new Date(year, month - 1, DD);
      if(isNaN(birth.getTime())) throw new Error("Data di nascita non valida nel CF.");

      let age = now.getFullYear() - birth.getFullYear();
      const mDiff = now.getMonth() - birth.getMonth();
      if (mDiff < 0 || (mDiff === 0 && now.getDate() < birth.getDate())) age--;

      return {
        cf,
        birthISO: birth.toISOString().slice(0,10),
        age,
        gender: female ? "F" : "M"
      };
    }

    function show(msg, cls=""){ out.innerHTML = `<div class="${cls}">${msg}</div>`; }

    async function startScan(){
      try{
        if(scanning) return;
        scanning = true;

        codeReader = new BrowserMultiFormatReader();
        const constraints = { video: { facingMode: { ideal: "environment" } } };
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        await video.play();

        const scanLoop = async () => {
          if(!scanning) return;
          try{
            const result = await codeReader.decodeOnceFromVideoElement(video);
            if(result && result.text){
              handleCandidate(result.text.trim());
            }
          }catch(e){
            if(!(e instanceof NotFoundException)){
              console.error(e);
            }
          }finally{
            if(scanning) requestAnimationFrame(scanLoop);
          }
        };
        requestAnimationFrame(scanLoop);
        show("Inquadra il codice a barre della tessera…");
      }catch(err){
        console.error(err);
        show("Impossibile accedere alla fotocamera. Su iOS serve HTTPS e permesso attivo.", "err");
        scanning = false;
      }
    }

    function stopScan(){
      scanning = false;
      if(codeReader){ try{ codeReader.reset(); }catch{} }
      if(currentStream){
        for(const t of currentStream.getTracks()) t.stop();
        currentStream = null;
      }
      show("Scanner fermo. Puoi riavviare o inserire il CF manualmente.");
    }

    function handleCandidate(text){
      // Estrae la prima sottostringa di 16 alfanumerici come possibile CF
      const m = text.toUpperCase().match(/[A-Z0-9]{16}/);
      const cfCandidate = m ? m[0] : text;
      try{
        const info = parseCF(cfCandidate);
        show(
          `CF: <b>${info.cf}</b><br>` +
          `Data di nascita: <b>${info.birthISO}</b><br>` +
          `Sesso: <b>${info.gender}</b><br>` +
          `Età oggi: <b>${info.age}</b> anni`,
          "ok"
        );
        // Ferma lo scan dopo lettura valida (evita doppioni)
        stopScan();
      }catch(e){
        show("Letto: "+text+"<br>"+e.message, "err");
      }
    }

    btnStart.onclick = startScan;
    btnStop.onclick  = stopScan;
    btnParse.onclick = () => {
      try{
        const info = parseCF(manual.value);
        show(
          `CF: <b>${info.cf}</b><br>` +
          `Data di nascita: <b>${info.birthISO}</b><br>` +
          `Sesso: <b>${info.gender}</b><br>` +
          `Età oggi: <b>${info.age}</b> anni`,
          "ok"
        );
      }catch(e){ show(e.message, "err"); }
    };
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Lettore CF">
  <link rel="manifest" href="manifest.json">
  <title>Lettore Codice Fiscale ‚Üí Et√†</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px;line-height:1.4}
    h1{font-size:20px;margin:0 0 12px}
    video{width:100%;max-width:480px;border:1px solid #ccc;border-radius:8px;background:#000}
    .row{margin:12px 0}
    .out{padding:10px;border:1px solid #eee;border-radius:8px;background:#fafafa;min-height:48px}
    button,input{font-size:16px;padding:10px;border-radius:8px;border:1px solid #ccc}
    .ok{color:#0a7}
    .err{color:#c00}
    small{color:#666}
  </style>
</head>
<body>
  <h1>Lettore Codice Fiscale ‚Üí Et√†</h1>
  <div id="out" class="out">Inquadra il barcode della tessera sanitaria o inserisci il CF manualmente.</div>
  <p><small>Tutto in locale: nessun dato inviato. Se sei su iPhone, apri questa app dalla schermata Home per la fotocamera.</small></p>

  <div class="row">
    <button id="btnStart">Avvia fotocamera</button>
    <button id="btnStop">Stop</button>
  </div>

  <div class="row">
    <video id="preview" muted playsinline></video>
  </div>

  <div class="row">
    <label for="manual">Oppure inserisci il Codice Fiscale:</label><br>
    <input id="manual" placeholder="RSSMRA85T10A562S" maxlength="16" style="width:100%;max-width:480px">
    <button id="btnParse">Calcola et√†</button>
  </div>

  <!-- Libreria ZXing -->
  <script type="module">
    import { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm/index.min.js";

    const video = document.getElementById('preview');
    const out = document.getElementById('out');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const manual = document.getElementById('manual');
    const btnParse = document.getElementById('btnParse');

    let codeReader = null;
    let scanning = false;

    function show(msg, cls=""){ 
      out.innerHTML = `<div class="${cls}">${msg}</div>`; 
      window.scrollTo({top:0,behavior:"smooth"});
    }

    function parseCF(cfRaw){
      const cf=(cfRaw||"").trim().toUpperCase();
      if(!/^[A-Z0-9]{16}$/.test(cf)) throw new Error("CF non valido.");
      const YY=cf.slice(6,8),M=cf[8],DD0=parseInt(cf.slice(9,11));
      const months={A:1,B:2,C:3,D:4,E:5,H:6,L:7,M:8,P:9,R:10,S:11,T:12};
      const month=months[M];if(!month)throw new Error("Mese CF non valido.");
      let DD=DD0,female=false;if(DD>=41){female=true;DD-=40;}
      const now=new Date(),yy=parseInt(YY),year=(yy<=now.getFullYear()%100)?2000+yy:1900+yy;
      const birth=new Date(year,month-1,DD);
      let age=now.getFullYear()-birth.getFullYear();
      const md=now.getMonth()-birth.getMonth();
      if(md<0||(md===0&&now.getDate()<birth.getDate())) age--;
      return{cf,birthISO:birth.toISOString().slice(0,10),age,gender:female?"F":"M"};
    }

    async function startScan(){
      try {
        if (scanning) return;
        scanning = true;

        const constraints = { video: { facingMode: { ideal: "environment" } } };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();

        show("üì∏ Fotocamera attiva. Inquadra il codice a barre‚Ä¶");

        codeReader = new BrowserMultiFormatReader();

        const hints = new Map();
        hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.CODE_39, BarcodeFormat.CODE_128]);
        codeReader.defaultHints = hints;

        // Lettura continua
        codeReader.decodeFromVideoDevice(undefined, video, (result, err) => {
          if (result) {
            handleCandidate(result.getText());
          } else if (err && !(err instanceof NotFoundException)) {
            console.warn(err);
          }
        });

      } catch (err) {
        console.error(err);
        show("Errore accesso fotocamera: consenti l‚Äôuso in Safari o apri dalla Home.","err");
        scanning = false;
      }
    }

    function stopScan(){
      scanning = false;
      if(codeReader){try{codeReader.reset();}catch{}}
      if(video.srcObject){
        video.srcObject.getTracks().forEach(t=>t.stop());
        video.srcObject=null;
      }
      show("Scanner fermo. Puoi riavviare o inserire il CF manualmente.");
    }

    function handleCandidate(text){
      const m=text.toUpperCase().match(/[A-Z0-9]{16}/);
      const cfCandidate=m?m[0]:text;
      try{
        const info=parseCF(cfCandidate);
        show(
          `CF: <b>${info.cf}</b><br>`+
          `Data di nascita: <b>${info.birthISO}</b><br>`+
          `Sesso: <b>${info.gender}</b><br>`+
          `Et√† oggi: <b>${info.age}</b> anni`,"ok"
        );
        stopScan();
      }catch(e){
        show("Letto: "+text+"<br>"+e.message,"err");
      }
    }

    btnStart.onclick=startScan;
    btnStop.onclick=stopScan;
    btnParse.onclick=()=>{
      try{
        const info=parseCF(manual.value);
        show(
          `CF: <b>${info.cf}</b><br>`+
          `Data di nascita: <b>${info.birthISO}</b><br>`+
          `Sesso: <b>${info.gender}</b><br>`+
          `Et√† oggi: <b>${info.age}</b> anni`,"ok"
        );
      }catch(e){show(e.message,"err");}
    };
  </script>
</body>
</html>

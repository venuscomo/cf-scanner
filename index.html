<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lettore Codice Fiscale → Età</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px;line-height:1.4}
    h1{font-size:20px;margin:0 0 12px}
    video{width:100%;max-width:480px;border:1px solid #ccc;border-radius:8px;background:#000}
    .row{margin:12px 0}
    .out{padding:10px;border:1px solid #eee;border-radius:8px;background:#fafafa;min-height:48px}
    button,input{font-size:16px;padding:10px;border-radius:8px;border:1px solid #ccc}
    .ok{color:#0a7}
    .err{color:#c00}
    small{color:#666}
  </style>
</head>
<body>
  <h1>Lettore Codice Fiscale → Età</h1>
  <div id="out" class="out">Inquadra il barcode della tessera sanitaria o inserisci il CF manualmente.</div>
  <p><small>Tutto in locale: nessun dato inviato. Su iPhone apri questa pagina dalla schermata Home per usare la fotocamera.</small></p>

  <div class="row">
    <button id="btnStart">Avvia fotocamera</button>
    <button id="btnStop">Stop</button>
  </div>

  <div class="row">
    <video id="preview" muted playsinline></video>
  </div>

  <div class="row">
    <label for="manual">Oppure inserisci il Codice Fiscale:</label><br>
    <input id="manual" placeholder="RSSMRA85T10A562S" maxlength="16" style="width:100%;max-width:480px">
    <button id="btnParse">Calcola età</button>
  </div>

  <!-- Libreria ZXing locale -->
  <script src="./zxing.min.js"></script>
  <script>
    const video    = document.getElementById('preview');
    const out      = document.getElementById('out');
    const btnStart = document.getElementById('btnStart');
    const btnStop  = document.getElementById('btnStop');
    const manual   = document.getElementById('manual');
    const btnParse = document.getElementById('btnParse');

    let codeReader = null;
    let currentStream = null;
    let scanning = false;

    function show(msg, cls=""){ out.innerHTML = `<div class="${cls}">${msg}</div>`; window.scrollTo({ top: 0, behavior: "smooth" }); }

    function parseCF(cfRaw){
      const cf = (cfRaw || "").trim().toUpperCase();
      if(!/^[A-Z0-9]{16}$/.test(cf)) throw new Error("CF non valido: 16 caratteri alfanumerici.");
      const YY = cf.slice(6,8), M = cf[8], DD0 = parseInt(cf.slice(9,11));
      const months = {A:1,B:2,C:3,D:4,E:5,H:6,L:7,M:8,P:9,R:10,S:11,T:12};
      const month = months[M]; if(!month) throw new Error("Mese CF non valido.");
      let DD=DD0, female=false; if(DD>=41){female=true;DD-=40;}
      const now=new Date(), yy=parseInt(YY), year=(yy<=now.getFullYear()%100)?2000+yy:1900+yy;
      const birth=new Date(year,month-1,DD); if(isNaN(birth)) throw new Error("Data di nascita non valida.");
      let age=now.getFullYear()-birth.getFullYear();
      const md=now.getMonth()-birth.getMonth();
      if(md<0||(md===0&&now.getDate()<birth.getDate())) age--;
      return {cf,birthISO:birth.toISOString().slice(0,10),age,gender:female?"F":"M"};
    }

    async function startScan(){
      try{
        if(scanning) return;
        scanning=true;

        if(!navigator.mediaDevices?.getUserMedia){
          show("Fotocamera non supportata. Su iPhone apri dalla schermata Home.", "err");
          scanning=false;return;
        }

        codeReader = new ZXing.BrowserMultiFormatReader();
        const constraints={video:{facingMode:{ideal:"environment"}},audio:false};
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject=currentStream; await video.play();

        show("Inquadra il codice a barre della tessera…");

        const formats=[ZXing.BarcodeFormat.CODE_39,ZXing.BarcodeFormat.CODE_128,ZXing.BarcodeFormat.QR_CODE];
        codeReader.hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);

        const loop=async()=>{
          if(!scanning) return;
          try{
            const result=await codeReader.decodeOnceFromVideoElement(video);
            if(result?.text) handleCandidate(result.text.trim());
          }catch(e){
            if(!(e instanceof ZXing.NotFoundException)) console.error(e);
          }finally{
            if(scanning) setTimeout(loop,200);
          }
        };
        loop();

      }catch(err){
        console.error(err);
        show("Errore accesso fotocamera: consenti l’uso in Safari o apri dalla Home.", "err");
        scanning=false;
      }
    }

    function stopScan(){
      scanning=false;
      if(codeReader){try{codeReader.reset();}catch{}}
      if(currentStream){for(const t of currentStream.getTracks())t.stop();currentStream=null;}
      show("Scanner fermo. Puoi riavviare o inserire il CF manualmente.");
    }

    function handleCandidate(text){
      const m=text.toUpperCase().match(/[A-Z0-9]{16}/);
      const cfCandidate=m?m[0]:text;
      try{
        const info=parseCF(cfCandidate);
        show(
          `CF: <b>${info.cf}</b><br>`+
          `Data di nascita: <b>${info.birthISO}</b><br>`+
          `Sesso: <b>${info.gender}</b><br>`+
          `Età oggi: <b>${info.age}</b> anni`,
          "ok"
        );
        stopScan();
      }catch(e){
        show("Letto: "+text+"<br>"+e.message, "err");
      }
    }

    btnStart.onclick=startScan;
    btnStop.onclick=stopScan;
    btnParse.onclick=()=>{
      try{
        const info=parseCF(manual.value);
        show(
          `CF: <b>${info.cf}</b><br>`+
          `Data di nascita: <b>${info.birthISO}</b><br>`+
          `Sesso: <b>${info.gender}</b><br>`+
          `Età oggi: <b>${info.age}</b> anni`,
          "ok"
        );
      }catch(e){show(e.message,"err");}
    };
  </script>
</body>
</html>
